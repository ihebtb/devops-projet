pipeline {
    agent any
    environment {
        registry = "ihebtb/devops"
        registryCredential = 'docker-hub-creds'
        dockerImage = 'tpAchat'
        SONARQUBE_URL = 'http://172.18.0.2:9000' // Add SonarQube URL here
    }
    
    stages {
        stage("Cloning Project") {
            steps {
                git branch: 'main', 
                url: 'https://github.com/ihebtb/devops-projet.git'
                echo 'Checkout stage done'
            }
        }
        
        stage('MVN Clean') {
            steps {
                sh 'mvn clean -e'
                echo 'Clean stage done'
            }
        }
    
        stage("Compile Project") {
            steps {
                sh 'mvn compile -X -e'
                echo 'Compile stage done'
            }
        }
        
        stage("Unit Tests") {
            steps {
                sh 'mvn test'
                echo 'Unit tests stage done'
            }
        }
        
        stage("SonarQube Analysis") {
            steps {
                withCredentials([string(credentialsId: '0af34e3d-d722-4829-8d48-03199ab990d5', variable: 'SONARQUBE_TOKEN')]) {
                    sh """
                        mvn sonar:sonar \
                            -Dsonar.projectKey=devops-projet \
                            -Dsonar.host.url=http://sonarqube:9000/ \
                            -Dsonar.login=$SONARQUBE_TOKEN \
                            -Dsonar.sources=src/main/java \
                            -Dsonar.tests=src/test/java
                    """
                }
                echo 'SonarQube analysis done'
            }
        }
          
        stage("Maven Build") {
            steps {
                sh "mvn package -DskipTests=true"
                echo 'Build project done'
            }
        }
        
        stage("Nexus Deploy") {
            steps {
                sh "mvn deploy:deploy-file -DgroupId=tn.esprit -DartifactId=FirstMavenProject -Dversion=1.0 -Dpackaging=jar -Dfile=target/FirstMavenProject-1.0.jar -DrepositoryId=deploymentRepo -Durl=http://192.168.10.114:8082/repository/maven-releases/"
                echo 'Nexus deployment done'
            }
        }
        
        stage('Building Docker Image') {
            steps {
                script {
                    dockerImage = docker.build("${registry}:${BUILD_NUMBER}")
                }
            }
        }
        
        stage('Deploy Docker Image') {
            steps {
                script {
                    docker.withRegistry('', registryCredential) {
                        dockerImage.push()
                    }
                }
            }
        }
        
        stage('Cleaning up') {
            steps {
                sh "docker rmi ${registry}:${BUILD_NUMBER}"
                echo 'Cleanup done'
            }
        }
    }
}

