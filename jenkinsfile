pipeline {
    agent any
    environment {
        registry = "ihebtb/devops"
        registryCredential = 'docker-hub-creds'
        dockerImage = 'tpAchat'
        SONARQUBE_URL = 'http://172.18.0.3:9000' // SonarQube URL
    }

    stages {
        stage("Cloning Project") {
            steps {
                git branch: 'main', url: 'https://github.com/ihebtb/devops-projet.git'
                echo 'Checkout stage done'
            }
        }

        stage('MVN Clean') {
            steps {
                sh 'mvn clean -e'
                echo 'Clean stage done'
            }
        }

        stage("Compile Project") {
            steps {
                sh 'mvn compile -X -e'
                echo 'Compile stage done'
            }
        }

        stage("Unit Tests") {
            steps {
                sh 'mvn test'
                echo 'Unit tests stage done'
            }
        }

        stage("SonarQube Analysis") {
            steps {
                withCredentials([string(credentialsId: 'sonarQube-tokken', variable: 'SONARQUBE_TOKEN')]) {
                    sh """
                        mvn sonar:sonar \
                            -Dsonar.projectKey=devops-projet \
                            -Dsonar.host.url=${SONARQUBE_URL} \
                            -Dsonar.login=${SONARQUBE_TOKEN} \
                            -Dsonar.sources=src/main/java \
                            -Dsonar.tests=src/test/java
                    """
                }
                echo 'SonarQube analysis done'
            }
        }

        stage("Maven Build") {
            steps {
                sh "mvn package -DskipTests=true"
                echo 'Build project done'
            }
        }

        stage("Nexus Deploy") {
            steps {
                sh """
    mvn deploy:deploy-file \
        -DgroupId=tn.esprit \
        -DartifactId=FirstMavenProject \
        -Dversion=1.0 \
        -Dpackaging=jar \
        -Dfile=target/tpAchatProject-1.0.jar \
        -DrepositoryId=nexus \
        -Durl=http://172.19.0.3:8081/repository/maven-releases/  \
        -Dhttp.timeout=60000

"""
                echo 'Nexus deployment done'
            }
        }

        stage('Building Docker Image') {
            steps {
                script {
                    dockerImage = docker.build("${registry}:${BUILD_NUMBER}")
                }
            }
        }

        stage('Deploy Docker Image') {
            steps {
                script {
                    docker.withRegistry('', registryCredential) {
                        dockerImage.push()
                    }
                }
            }
        }

        stage('Cleaning up') {
            steps {
                sh "docker rmi ${registry}:${BUILD_NUMBER}"
                echo 'Cleanup done'
            }
        }
    }
}
